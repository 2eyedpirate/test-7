<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <meta name="description" content="Aerovia - AI-powered volunteer matching platform connecting NGOs with skilled volunteers">
  <title>Aerovia ‚Äî Where Purpose Meets Partnership</title>
  <style>
    /* ---------- Original design CSS (kept intact) ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #0A84FF;
      --primary-dark: #0066CC;
      --text-primary: #1D1D1F;
      --text-secondary: #6E6E73;
      --text-tertiary: #86868B;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-glass: rgba(255, 255, 255, 0.72);
      --border: rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 12px 48px rgba(0, 0, 0, 0.12);
      --success: #34C759;
      --warning: #FF9500;
    }

    @media (prefers-color-scheme: dark) {
      :root {
        --primary: #0A84FF;
        --primary-dark: #409CFF;
        --text-primary: #F5F5F7;
        --text-secondary: #A1A1A6;
        --text-tertiary: #6E6E73;
        --bg-primary: #000000;
        --bg-secondary: #1D1D1F;
        --bg-glass: rgba(29, 29, 31, 0.72);
        --border: rgba(255, 255, 255, 0.1);
        --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.3);
        --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.4);
        --shadow-lg: 0 12px 48px rgba(0, 0, 0, 0.5);
      }
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }
    html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    body { font-family: 'Inter', -apple-system, BlinkMacSystemFont, sans-serif; color: var(--text-primary); background: var(--bg-primary); line-height: 1.6; overflow-x: hidden; }

    /* Notification */
    .notification { position: fixed; top: 20px; right: 20px; padding: 16px 24px; border-radius: 12px; font-weight: 500; z-index: 10000; transform: translateX(400px); transition: all 0.3s ease; box-shadow: var(--shadow-lg); max-width: 360px; }
    .notification.show { transform: translateX(0); }
    .notification.success { background: var(--success); color: white; }
    .notification.error { background: #FF3B30; color: white; }

    /* Navigation */
    nav { position: fixed; top: 0; left: 0; right: 0; z-index: 1000; background: var(--bg-glass); backdrop-filter: saturate(180%) blur(20px); border-bottom: 1px solid var(--border); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }
    nav.scrolled { background: var(--bg-glass); box-shadow: var(--shadow-sm); }
    .nav-container { max-width: 1280px; margin: 0 auto; padding: 0 max(20px, env(safe-area-inset-right)); display: flex; align-items: center; justify-content: space-between; height: 52px; }
    .nav-logo { font-size: 21px; font-weight: 600; color: var(--text-primary); text-decoration: none; }
    .nav-links { display: flex; gap: 24px; align-items: center; }
    .nav-links a { color: var(--text-secondary); text-decoration: none; font-size: 14px; font-weight: 400; transition: color 0.2s; }
    .nav-links a.cta { color: var(--primary); font-weight: 500; }

    /* Hero */
    .hero { min-height: 72vh; display: flex; align-items: center; justify-content: center; padding: 110px 20px 60px; }
    .hero-content { max-width: 980px; text-align: center; }
    .hero h1 { font-size: clamp(36px, 7vw, 72px); font-weight: 700; line-height: 1.02; margin-bottom: 18px; }
    .hero p { font-size: 18px; color: var(--text-secondary); margin-bottom: 26px; }

    /* Basic Buttons */
    .btn { padding: 12px 18px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary { background: var(--primary); color: white; }
    .btn-secondary { background: transparent; border: 1.5px solid var(--border); color: var(--primary); }

    /* Signin & Onboarding */
    .signin-section { padding: 80px 20px; max-width: 520px; margin: 0 auto; }
    .signin-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 32px; box-shadow: var(--shadow-md); }
    .signin-card h2 { font-size: 28px; margin-bottom: 6px; }
    .signin-subtitle { color: var(--text-secondary); margin-bottom: 20px; }

    .input-group { margin-bottom: 14px; }
    .input-group label { display: block; color: var(--text-secondary); margin-bottom: 8px; }
    .input-group input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); font-family: inherit; }

    .divider { display: flex; align-items: center; gap: 16px; margin: 20px 0; color: var(--text-tertiary); }
    .divider::before, .divider::after { content: ''; flex: 1; height: 1px; background: var(--border); }

    /* NGO list */
    .ngo-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 12px; margin-top: 12px; }
    .ngo-card { background: var(--bg-primary); border: 1px solid var(--border); padding: 12px; border-radius: 10px; cursor: pointer; display: flex; flex-direction: column; gap: 6px; }
    .ngo-card.selected { outline: 2px solid var(--primary); box-shadow: var(--shadow-sm); }
    .ngo-card h4 { margin: 0; font-size: 15px; }
    .ngo-card p { margin: 0; color: var(--text-secondary); font-size: 13px; }

    /* Dashboard / matches */
    .dashboard { display: none; padding: 100px 20px; max-width: 1100px; margin: 0 auto; }
    .dashboard.show { display: block; }
    .matches-grid { display: grid; gap: 20px; margin-top: 20px; }
    .match-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 12px; padding: 18px; }
    .match-card h3 { margin: 6px 0; }
    .match-score { background: var(--success); color: #fff; padding: 6px 10px; border-radius: 20px; font-weight: 700; display: inline-block; }

    /* Modal */
    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items: center; justify-content: center; z-index: 2000; }
    .modal { background: var(--bg-primary); padding: 18px; border-radius: 12px; width: 100%; max-width: 520px; border: 1px solid var(--border); }

    /* Footer */
    footer { padding: 60px 20px; text-align: center; color: var(--text-tertiary); font-size: 13px; border-top: 1px solid var(--border); }

    @media (max-width: 760px) {
      .hero { padding: 80px 16px 40px; }
      .signin-card { padding: 20px; }
    }
  </style>
</head>
<body>

  <!-- Notification -->
  <div id="notification" class="notification"></div>

  <nav id="nav">
    <div class="nav-container">
      <a href="#" class="nav-logo" onclick="showLanding()">Aerovia</a>
      <div class="nav-links" id="navLinks">
        <a href="#features">Features</a>
        <a href="#how">How it works</a>
        <a href="#signin" class="cta" onclick="showSignin()">Get Started</a>
      </div>
    </div>
  </nav>

  <!-- Dashboard -->
  <section class="dashboard" id="dashboard">
    <div style="display:flex;justify-content:space-between;align-items:center;gap:16px;">
      <div>
        <h1 style="font-size:22px;margin-bottom:6px">Welcome back, <span id="userName">User</span>! üëã</h1>
        <div id="dashboardMessage" style="color:var(--text-secondary)"></div>
      </div>
      <div style="display:flex;align-items:center;gap:12px">
        <div style="background:var(--bg-secondary);padding:8px 12px;border-radius:10px;border:1px solid var(--border)">vTokens: <strong id="tokenCount">0</strong></div>
        <button class="btn btn-secondary" onclick="openProfileEditor()">Edit profile</button>
        <button class="btn btn-secondary" onclick="logout()">Logout</button>
      </div>
    </div>

    <div id="ngoCreateArea" style="margin-top:14px"></div>

    <div id="matchesContainer" class="matches-grid"></div>
  </section>

  <main id="mainContent">
    <section class="hero">
      <div class="hero-content">
        <div class="hero-badge">üåç SDG 17 ‚Äî Partnerships for the Goals</div>
        <h1>Where purpose<br>meets partnership</h1>
        <p>An intelligent platform that connects NGOs with volunteers through thoughtful, AI-powered matching ‚Äî creating meaningful collaborations that drive real impact.</p>

        <div style="display:flex;gap:12px;justify-content:center;flex-wrap:wrap;margin-top:18px">
          <button class="btn btn-primary" onclick="showSignin()">Get started free ‚Üí</button>
          <button class="btn btn-secondary" onclick="scrollToHow()">Learn more</button>
        </div>
      </div>
    </section>

    <section class="features" id="features">
      <div style="max-width:980px;margin:0 auto;text-align:center;padding:40px 20px">
        <h2>Built for impact</h2>
        <p style="color:var(--text-secondary)">Every feature designed to create authentic connections between organizations and volunteers who share the same vision.</p>
      </div>

      <div class="features-grid" style="padding: 0 20px 60px">
        <div class="feature-card"><div class="feature-icon">üéØ</div><h3>AI-Powered Matching</h3><p>Our intelligent algorithm analyzes skills, interests, location, and availability to find perfect matches in seconds.</p></div>
        <div class="feature-card"><div class="feature-icon">üí°</div><h3>Transparent Reasoning</h3><p>Every recommendation includes a clear explanation of why it's a great fit, building trust through transparency.</p></div>
        <div class="feature-card"><div class="feature-icon">‚ö°</div><h3>Seamless Experience</h3><p>Intuitive interface designed for quick signup, easy matching, and effortless collaboration from day one.</p></div>
        <div class="feature-card"><div class="feature-icon">üîí</div><h3>Verified Partners</h3><p>All NGOs undergo rigorous verification to ensure legitimacy and commitment to genuine social impact.</p></div>
      </div>
    </section>

    <section class="how-it-works" id="how">
      <div style="max-width:900px;margin:0 auto;text-align:center;padding:40px 20px">
        <h2>How Aerovia works</h2>
        <p style="color:var(--text-secondary)">A simple 4-step process that brings the right people together</p>
      </div>

      <div class="steps" style="max-width:900px;margin:0 auto 80px;padding:0 20px">
        <div class="step"><div class="step-number">1</div><div class="step-content"><h3>Create your profile</h3><p>Share your skills, interests, location, and availability. Takes less than 2 minutes to get started.</p></div></div>
        <div class="step"><div class="step-number">2</div><div class="step-content"><h3>Get smart matches</h3><p>AI analyzes your profile against thousands of opportunities to surface the best fits for you.</p></div></div>
        <div class="step"><div class="step-number">3</div><div class="step-content"><h3>Review & connect</h3><p>See detailed compatibility scores and reasoning, then connect directly with your top matches.</p></div></div>
        <div class="step"><div class="step-number">4</div><div class="step-content"><h3>Make impact</h3><p>Start volunteering, track your hours, celebrate milestones, and create lasting change.</p></div></div>
      </div>
    </section>

    <!-- Sign in card -->
    <section class="signin-section" id="signin">
      <div class="signin-card">
        <h2>Join Aerovia</h2>
        <p class="signin-subtitle">Start making impact today - free forever</p>

        <form id="authForm">
          <div class="input-group">
            <label for="email">Email address</label>
            <input id="email" type="email" placeholder="you@example.com" required autocomplete="email" />
          </div>

          <div class="input-group">
            <label for="password">Password</label>
            <input id="password" type="password" placeholder="Enter your password" required autocomplete="current-password" minlength="6" />
          </div>

          <button type="submit" class="btn btn-primary btn-full" id="submitBtn">Get started</button>
        </form>

        <div class="divider">or try demo</div>

        <div style="margin-bottom:16px;">
          <button id="googleSignInBtn" type="button" class="btn btn-primary btn-full" style="display:flex;align-items:center;justify-content:center;gap:8px">
            <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" alt="" style="width:18px;height:18px"> Continue with Google
          </button>
        </div>

        <div class="role-buttons">
          <button type="button" class="btn btn-secondary" onclick="quickLogin('volunteer')">üå± Demo Volunteer</button>
          <button type="button" class="btn btn-secondary" onclick="quickLogin('ngo')">üè¢ Demo NGO</button>
        </div>

        <div style="text-align:center;margin-top:14px;font-size:12px;color:var(--text-tertiary)">üîí Demo data saved locally ‚Ä¢ No real emails sent</div>
      </div>
    </section>

    <!-- Onboarding: username + operating zone + NGO picker -->
    <section class="signin-section" id="onboard" style="display:none;">
      <div class="signin-card">
        <h2>Finish creating your profile</h2>
        <p class="signin-subtitle">Pick a username, select your operating zone, and choose an NGO to follow</p>

        <div style="margin-bottom:12px;">
          <label style="display:block;font-weight:600;margin-bottom:8px;">Suggested username</label>
          <div style="display:flex;gap:8px;align-items:center;">
            <input id="usernameInput" type="text" placeholder="choose-a-username" style="flex:1;padding:12px;border-radius:8px;border:1px solid var(--border)" />
            <button id="generateUsernameBtn" class="btn btn-secondary" type="button">Generate</button>
          </div>
          <div id="usernameFeedback" style="margin-top:8px;color:var(--text-tertiary);font-size:13px;"></div>
        </div>

        <div style="margin-bottom:12px;">
          <h3 style="margin-bottom:8px;">Select Your Operating Zone</h3>
          <select id="citySelect" onchange="loadNGOs()" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border);">
            <option value="">-- Choose a City --</option>
            <option value="Delhi">Delhi</option>
            <option value="Mumbai">Mumbai</option>
            <option value="Bengaluru">Bengaluru</option>
            <option value="Hyderabad">Hyderabad</option>
            <option value="Chennai">Chennai</option>
            <option value="Kolkata">Kolkata</option>
            <option value="Pune">Pune</option>
            <option value="Ahmedabad">Ahmedabad</option>
            <option value="Jaipur">Jaipur</option>
            <option value="Kochi">Kochi</option>
          </select>

          <div id="ngoList" class="ngo-list" style="margin-top:12px;"></div>
          <div id="ngoSelectionFeedback" style="margin-top:8px;color:var(--text-tertiary);font-size:13px;">Pick an NGO to follow/associate with your profile.</div>
        </div>

        <div style="margin-top:14px;display:flex;gap:12px;justify-content:flex-end;">
          <button id="skipProfileBtn" class="btn btn-secondary">Skip</button>
          <button id="saveProfileBtn" class="btn btn-primary">Save profile</button>
        </div>
      </div>
    </section>

  </main>

  <!-- Profile Edit Modal -->
  <div id="profileModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Edit profile</h3>
      <div style="margin-top:12px;">
        <label class="small-muted">Name</label>
        <input id="editName" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px;" />
      </div>
      <div style="margin-top:12px;">
        <label class="small-muted">Location</label>
        <input id="editLocation" type="text" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px;" />
      </div>
      <div style="margin-top:12px;">
        <label class="small-muted">Skills (comma separated)</label>
        <input id="editSkills" type="text" placeholder="teaching,writing,marketing" style="width:100%;padding:10px;border-radius:8px;border:1px solid var(--border);margin-top:6px;" />
      </div>
      <div style="display:flex;gap:10px;margin-top:16px;justify-content:flex-end;">
        <button class="btn btn-secondary" onclick="closeProfileEditor()">Cancel</button>
        <button class="btn btn-primary" onclick="saveProfileEdits()">Save</button>
      </div>
    </div>
  </div>

  <footer>
    <div style="max-width:1280px;margin:0 auto;padding:24px;text-align:center;color:var(--text-tertiary);font-size:13px;">
      <div style="margin-bottom:12px;">
        <a href="#" style="margin-right:12px;color:var(--text-secondary)">About</a>
        <a href="#" style="margin-right:12px;color:var(--text-secondary)">Privacy</a>
        <a href="#" style="margin-right:12px;color:var(--text-secondary)">Terms</a>
        <a href="#" style="margin-right:12px;color:var(--text-secondary)">For NGOs</a>
        <a href="#" style="color:var(--text-secondary)">Support</a>
      </div>
      <div>¬© 2026 Aerovia. Advancing SDG 17 through intelligent partnerships. Made with ‚ù§Ô∏è for social good.</div>
    </div>
  </footer>

  <!-- NGO dataset (same as you provided) -->
  <script>
    window.ngoData = {
      Delhi: [
        { name: "Goonj", focus: "Urban Poverty & Clothing" },
        { name: "Smile Foundation", focus: "Education & Children" },
        { name: "CRY", focus: "Child Rights" },
        { name: "Pratham", focus: "Education" },
        { name: "Teach For India", focus: "Education" },
        { name: "Action Against Hunger", focus: "Nutrition" },
        { name: "HelpAge India", focus: "Elderly Care" },
        { name: "Uday Foundation", focus: "Healthcare" },
        { name: "Deepalaya", focus: "Community Development" },
        { name: "Azad Foundation", focus: "Women Empowerment" }
      ],
      Mumbai: [
        { name: "Akanksha Foundation", focus: "Education" },
        { name: "Beach Please", focus: "Environment" },
        { name: "Nanhi Kali", focus: "Girl Education" },
        { name: "Reality Gives", focus: "Youth Development" },
        { name: "Sneha", focus: "Women Safety" },
        { name: "Apnalaya", focus: "Urban Slums" },
        { name: "Magic Bus", focus: "Life Skills" },
        { name: "Aseema", focus: "Schooling" },
        { name: "Muskaan", focus: "Child Welfare" },
        { name: "Salaam Bombay", focus: "Adolescent Support" }
      ],
      Bengaluru: [
        { name: "Make A Difference", focus: "Child Welfare" },
        { name: "SayTrees", focus: "Afforestation" },
        { name: "Akshaya Patra", focus: "Midday Meals" },
        { name: "Dream A Dream", focus: "Youth Development" },
        { name: "Hasiru Dala", focus: "Waste Workers" },
        { name: "Swasthi", focus: "Public Health" },
        { name: "The/Nudge", focus: "Poverty Alleviation" },
        { name: "Samatva", focus: "Social Inclusion" },
        { name: "Reap Benefit", focus: "Civic Issues" },
        { name: "Karunashraya", focus: "Palliative Care" }
      ],
      Hyderabad: [
        { name: "Helping Hands Foundation", focus: "Disaster Relief" },
        { name: "U&I Trust", focus: "Education" },
        { name: "Sphoorti", focus: "Child Care" },
        { name: "SAFA", focus: "Women Development" },
        { name: "Deccan Development Society", focus: "Sustainable Agriculture" },
        { name: "Roshni Counselling", focus: "Mental Health" },
        { name: "Manzil", focus: "Education" },
        { name: "Asha Foundation", focus: "Healthcare" },
        { name: "YouWeCan", focus: "Youth Empowerment" },
        { name: "Helping Hand", focus: "Community Aid" }
      ],
      Chennai: [
        { name: "Bhumi", focus: "Youth Volunteering" },
        { name: "Hand in Hand", focus: "Livelihoods" },
        { name: "Udavum Karangal", focus: "Orphan Care" },
        { name: "Sneha", focus: "Emotional Support" },
        { name: "Aravind Eye Care", focus: "Healthcare" },
        { name: "Rural Education Development", focus: "Education" },
        { name: "The Banyan", focus: "Mental Health" },
        { name: "ExNoRa", focus: "Environment" },
        { name: "Agastya Foundation", focus: "Science Education" },
        { name: "Sevalaya", focus: "Rural Development" }
      ],
      Kolkata: [
        { name: "CINI", focus: "Child Nutrition" },
        { name: "Prayasam", focus: "Mental Health" },
        { name: "Calcutta Rescue", focus: "Healthcare" },
        { name: "Hope Foundation", focus: "Street Children" },
        { name: "Sanlaap", focus: "Anti-Trafficking" },
        { name: "Child in Need Institute", focus: "Health & Education" },
        { name: "Anudip", focus: "Digital Skills" },
        { name: "Tiljala Shed", focus: "Slum Education" },
        { name: "Ek Tara", focus: "Music Education" },
        { name: "Prayas India", focus: "Social Reform" }
      ],
      Pune: [
        { name: "Door Step School", focus: "Education" },
        { name: "Jeevitnadi", focus: "River Conservation" },
        { name: "Teach For India", focus: "Education" },
        { name: "Shelter Associates", focus: "Urban Housing" },
        { name: "Mitra", focus: "Disaster Response" },
        { name: "BAIF", focus: "Rural Livelihoods" },
        { name: "Deep Griha", focus: "Community Welfare" },
        { name: "Grampari", focus: "Women Empowerment" },
        { name: "Jnanaprabodhini", focus: "Youth Development" },
        { name: "Navjeevan", focus: "Rehabilitation" }
      ],
      Ahmedabad: [
        { name: "Manav Sadhna", focus: "Community Development" },
        { name: "Blind People‚Äôs Association", focus: "Disability Support" },
        { name: "SEWA", focus: "Women Workers" },
        { name: "Self Employed Women‚Äôs Association", focus: "Livelihoods" },
        { name: "Prayas", focus: "Education" },
        { name: "Sewa Rural", focus: "Healthcare" },
        { name: "Eklavya", focus: "Child Education" },
        { name: "Gujarat Forum", focus: "Urban Issues" },
        { name: "Sahaj", focus: "Social Justice" },
        { name: "Janvikas", focus: "Tribal Development" }
      ],
      Jaipur: [
        { name: "Barefoot College", focus: "Rural Development" },
        { name: "Apna Ghar", focus: "Women Safety" },
        { name: "I-India", focus: "Child Education" },
        { name: "Gramin Vikas", focus: "Village Development" },
        { name: "Seva Mandir", focus: "Tribal Welfare" },
        { name: "Jan Sahas", focus: "Anti-Bonded Labour" },
        { name: "URMUL", focus: "Livelihoods" },
        { name: "Sankalp", focus: "Skill Training" },
        { name: "Smile Society", focus: "Education" },
        { name: "Prayas Trust", focus: "Social Upliftment" }
      ],
      Kochi: [
        { name: "SEED", focus: "Sustainable Development" },
        { name: "CarePlus", focus: "Healthcare Access" },
        { name: "Thanal", focus: "Environment" },
        { name: "Rajagiri Outreach", focus: "Community Services" },
        { name: "Sanjeevani", focus: "Palliative Care" },
        { name: "Kudumbashree", focus: "Women Empowerment" },
        { name: "Sneha Bhavan", focus: "Orphan Care" },
        { name: "Rebuild Kerala", focus: "Disaster Recovery" },
        { name: "Green Army", focus: "Environmental Action" },
        { name: "Hope Foundation Kerala", focus: "Child Welfare" }
      ]
    };
    window.__selectedNgoForOnboard = null;
  </script>

  <!-- ---------- Full client UI and Firebase integration (long, explicit) ---------- -->
  <script>
    /* This script keeps a full, explicit implementation (non-minified, verbose),
       with local fallback and with Firebase-backed flows for Google sign-in,
       onboarding (username + operating zone + NGO selection), vTokens,
       applying/bookmarking, and profile editing.
       It's intentionally long ‚Äî so you have everything in one file and nothing removed. */

    // -------------------------
    // Utility functions
    // -------------------------
    function $id(id) { return document.getElementById(id); }

    function showNotification(message, type = 'success') {
      const n = $id('notification');
      n.textContent = message;
      n.className = `notification ${type} show`;
      n.style.display = 'block';
      setTimeout(() => {
        n.classList.remove('show');
        n.style.display = 'none';
      }, 3500);
    }

    function slugifyName(name) {
      return (name || 'user')
        .toLowerCase()
        .replace(/[^a-z0-9]+/g, '-')
        .replace(/^-+|-+$/g, '')
        .slice(0, 24);
    }

    function makeCandidate(displayName) {
      const base = slugifyName((displayName || '').split(' ')[0] || displayName || 'user');
      const rand = Math.floor(100 + Math.random() * 900);
      return `${base}${rand}`;
    }

    // -------------------------
    // App state (local)
    // -------------------------
    let currentUser = null;
    // simple seed opportunities (used until Firestore loaded or if not connected)
    let opportunities = [
      { id: 1, title: "Weekend Tree Planting - Delhi", ngo: "Green Earth Foundation", location: "Delhi", skills: ["teamwork", "outdoor", "fundraising"], description: "Join monthly tree planting events. Perfect for beginners!", score: 0, reasoning: "" },
      { id: 2, title: "Math Tutoring Mentor - Mumbai", ngo: "Teach For India", location: "Mumbai", skills: ["teaching", "mathematics"], description: "2 hours/week helping underprivileged students", score: 0, reasoning: "" },
      { id: 3, title: "Content Writer - Remote", ngo: "Digital Volunteers", location: "Remote", skills: ["writing", "content"], description: "Create social media content for NGOs", score: 0, reasoning: "" },
      { id: 4, title: "Fundraising Assistant - Bangalore", ngo: "Hope Foundation", location: "Bangalore", skills: ["fundraising", "marketing"], description: "Help organize crowdfunding campaigns", score: 0, reasoning: "" }
    ];

    // helper to persist local profile
    function saveLocalProfile(profile) {
      currentUser = profile;
      localStorage.setItem('aeroviaUser', JSON.stringify(profile));
    }

    function loadLocalProfile() {
      try {
        const s = localStorage.getItem('aeroviaUser');
        if (!s) return null;
        return JSON.parse(s);
      } catch (e) { return null; }
    }

    // -------------------------
    // UI wiring (non-Firebase flows & general)
    // -------------------------
    document.addEventListener('DOMContentLoaded', () => {
      // initialize UI
      initAnimations();

      // load saved user if any
      const saved = loadLocalProfile();
      if (saved) {
        currentUser = saved;
        calculateMatches();
        renderDashboard();
      }

      // wire form
      const authForm = $id('authForm');
      if (authForm) authForm.addEventListener('submit', handleAuthForm);

      // wire Google button (module will override if firebase present)
      const googleBtn = $id('googleSignInBtn');
      if (googleBtn) googleBtn.addEventListener('click', () => {
        // if firebase available, it will intercept; otherwise show message
        if (!window.firebaseAuth) {
          showNotification('Firebase not initialized locally. Use demo login or configure Firebase.', 'error');
          return;
        }
        // else firebase module handles clicking (attached later)
      });

      // onboarding UI buttons
      $id('generateUsernameBtn')?.addEventListener('click', () => {
        const suggestion = makeCandidate((currentUser && currentUser.name) || '');
        $id('usernameInput').value = suggestion;
        $id('usernameFeedback').textContent = 'New suggestion generated';
      });

      $id('saveProfileBtn')?.addEventListener('click', async () => {
        await handleOnboardSave();
      });

      $id('skipProfileBtn')?.addEventListener('click', async () => {
        await handleOnboardSkip();
      });

      // initial NGO list empty
      $id('ngoList').innerHTML = '<div style="color:var(--text-tertiary)">Choose a city to see NGOs</div>';
    });

    function initAnimations() {
      const nav = $id('nav');
      window.addEventListener('scroll', () => {
        if (window.scrollY > 50) nav.classList.add('scrolled'); else nav.classList.remove('scrolled');
      });
      const observer = new IntersectionObserver((entries) => {
        entries.forEach(entry => {
          if (entry.isIntersecting) entry.target.classList.add('active');
        });
      }, { threshold: 0.1, rootMargin: '0px 0px -50px 0px' });
      document.querySelectorAll('.reveal').forEach(el => observer.observe(el));
    }

    // -------------------------
    // Authentication: demo/local form
    // -------------------------
    async function handleAuthForm(e) {
      e.preventDefault();
      const email = $id('email').value.trim();
      const password = $id('password').value;
      const btn = $id('submitBtn');
      const oldText = btn.innerHTML;
      btn.classList.add('loading'); btn.innerHTML = 'Processing...';

      // Demo accounts
      const demoVolunteer = { id: 'demo-vol', email: 'volunteer@aerovia.com', password: 'demo123', role: 'volunteer', name: 'Priya Sharma', skills: ['teaching', 'teamwork'], location: 'Delhi', tokens: 10 };
      const demoNGO = { id: 'demo-ngo', email: 'ngo@aerovia.com', password: 'demo123', role: 'ngo', name: 'Green Earth Foundation', skills: ['fundraising'], location: 'Delhi', tokens: 0 };

      let user = null;
      if (email === demoVolunteer.email && password === demoVolunteer.password) user = demoVolunteer;
      else if (email === demoNGO.email && password === demoNGO.password) user = demoNGO;
      else {
        // create local user (no server)
        user = {
          id: Date.now().toString(),
          email,
          role: email.includes('ngo') ? 'ngo' : 'volunteer',
          name: email.split('@')[0].replace('.', ' ').replace(/^\w/, c => c.toUpperCase()),
          skills: ['teamwork'],
          location: 'India',
          tokens: 5
        };
      }

      saveLocalProfile(user);
      showNotification(`Signed in as ${user.name} (local demo)`, 'success');

      setTimeout(() => {
        btn.classList.remove('loading'); btn.innerHTML = oldText;
        // show onboarding if no username / operating zone
        if (!user.username || !user.operatingZone) {
          $id('signin').classList.add('hidden');
          $id('onboard').style.display = 'block';
          $id('mainContent').style.display = 'none';
          // prefill suggestion
          $id('usernameInput').value = makeCandidate(user.name || user.email || 'user');
          $id('usernameFeedback').textContent = '';
        } else {
          calculateMatches();
          renderDashboard();
        }
      }, 900);
    }

    // -------------------------
    // Onboarding: render NGO list & selection
    // -------------------------
    window.loadNGOs = function loadNGOs() {
      const city = $id('citySelect').value;
      const ngoList = $id('ngoList');
      window.__selectedNgoForOnboard = null;
      ngoList.innerHTML = '';
      if (!city) { ngoList.innerHTML = '<div style="color:var(--text-tertiary)">Choose a city to see NGOs</div>'; return; }
      const list = (window.ngoData && window.ngoData[city]) || [];
      if (!list.length) { ngoList.innerHTML = '<div style="color:var(--text-tertiary)">No NGOs available for this city.</div>'; return; }
      list.forEach(n => {
        const card = document.createElement('div');
        card.className = 'ngo-card';
        card.tabIndex = 0;
        card.innerHTML = `<h4>${n.name}</h4><p>${n.focus}</p>`;
        card.addEventListener('click', () => {
          ngoList.querySelectorAll('.ngo-card').forEach(c => c.classList.remove('selected'));
          card.classList.add('selected');
          window.__selectedNgoForOnboard = n;
          $id('ngoSelectionFeedback').textContent = `Selected: ${n.name} ‚Äî ${n.focus}`;
        });
        card.addEventListener('keypress', (e) => { if (e.key === 'Enter') card.click(); });
        ngoList.appendChild(card);
      });
    };

    // Onboard Save
    async function handleOnboardSave() {
      const desired = ($id('usernameInput').value || '').trim().toLowerCase();
      const feedback = $id('usernameFeedback');
      if (!desired || !/^[a-z0-9-]{3,24}$/.test(desired)) { feedback.textContent = 'Username must be 3‚Äì24 chars: letters/numbers/dashes only.'; return; }
      $id('saveProfileBtn').disabled = true; $id('saveProfileBtn').classList.add('loading'); feedback.textContent = 'Saving...';

      const city = $id('citySelect').value || '';
      const selectedNgo = window.__selectedNgoForOnboard || null;

      try {
        // If firebase module is present and firebase user exists, use transactional reserve
        if (window.reserveUsernameAndCreateUser && window._firebaseUserForOnboard) {
          const fu = window._firebaseUserForOnboard;
          const profileData = { email: fu.email || '', name: fu.displayName || '', photoURL: fu.photoURL || '', tokens: 10, operatingZone: city, preferredNgo: selectedNgo };
          await window.reserveUsernameAndCreateUser(fu.uid, desired, profileData);
          // the onAuthStateChanged will map to localStorage and show the dashboard
          showNotification('Profile saved to Firebase ‚Äî redirecting', 'success');
          // small delay to allow mapping
          setTimeout(() => {
            $id('onboard').style.display = 'none';
            // render via local stored data (module wrote it)
            try { renderDashboardFromLocal(); } catch(e) { /* ignore */ }
          }, 700);
        } else {
          // local fallback
          const stored = loadLocalProfile() || {};
          stored.username = desired;
          stored.operatingZone = city;
          stored.preferredNgo = selectedNgo;
          stored.tokens = stored.tokens != null ? stored.tokens : 10;
          saveLocalProfile(stored);
          showNotification('Profile saved locally', 'success');
          $id('onboard').style.display = 'none';
          calculateMatches();
          renderDashboardFromLocal();
        }
      } catch (err) {
        console.error(err);
        if (err.message === 'username-already-taken') feedback.textContent = 'That username is already taken ‚Äî try a different one.';
        else feedback.textContent = 'Error saving profile. Try again.';
      } finally {
        $id('saveProfileBtn').disabled = false; $id('saveProfileBtn').classList.remove('loading');
      }
    }

    // Onboard Skip
    async function handleOnboardSkip() {
      $id('skipProfileBtn').disabled = true;
      const city = $id('citySelect').value || '';
      const selectedNgo = window.__selectedNgoForOnboard || null;

      try {
        if (window.reserveUsernameAndCreateUser && window._firebaseUserForOnboard) {
          const fu = window._firebaseUserForOnboard;
          const fallback = `${slugifyName(fu.displayName || fu.email || 'user')}-${fu.uid.slice(0,6)}`;
          await window.reserveUsernameAndCreateUser(fu.uid, fallback, { email: fu.email || '', name: fu.displayName || '', tokens: 5, operatingZone: city, preferredNgo: selectedNgo });
          showNotification('Profile created with fallback username', 'success');
          setTimeout(() => { try { renderDashboardFromLocal(); } catch (e){} }, 600);
        } else {
          const stored = loadLocalProfile() || {};
          stored.username = stored.username || ('user-'+Math.floor(Math.random()*10000));
          stored.operatingZone = city;
          stored.preferredNgo = selectedNgo;
          stored.tokens = stored.tokens != null ? stored.tokens : 5;
          saveLocalProfile(stored);
          showNotification('Profile saved locally (skipped)', 'success');
          $id('onboard').style.display = 'none';
          renderDashboardFromLocal();
        }
      } catch (e) {
        console.error(e);
        showNotification('Skip failed ‚Äî try saving instead', 'error');
      } finally {
        $id('skipProfileBtn').disabled = false;
      }
    }

    // -------------------------
    // Dashboard & matches rendering
    // -------------------------
    function calculateMatches() {
      if (!currentUser) return;
      opportunities.forEach(opp => {
        let score = 0;
        const skillMatches = (currentUser.skills || []).filter(skill => opp.skills.includes(skill));
        score += Math.min(skillMatches.length * 25, 50);
        if ((currentUser.location || '').toLowerCase().includes(opp.location.toLowerCase()) || opp.location === 'Remote') score += 30;
        if (currentUser.role === 'volunteer') score += 20;
        opp.score = Math.round(score);
        opp.reasoning = `${skillMatches.length} skill matches ‚Ä¢ ${opp.location} opportunity`;
      });
      opportunities.sort((a,b) => b.score - a.score);
    }

    function renderDashboardFromLocal() {
      const stored = loadLocalProfile() || {};
      currentUser = stored;
      if (!currentUser) currentUser = { name:'User', role:'volunteer', tokens:0 };

      // personalize matches
      calculateMatches();
      const container = $id('matchesContainer');
      container.innerHTML = '';
      const zone = currentUser.operatingZone || null;
      const list = opportunities.filter(o => !zone || o.location.toLowerCase().includes(zone.toLowerCase()) || o.location === 'Remote');
      list.forEach(opp => {
        const card = document.createElement('div'); card.className = 'match-card';
        const canBoost = (currentUser.tokens || 0) > 0;
        card.innerHTML = `
          <div style="display:flex;justify-content:space-between;align-items:center">
            <div>
              <div class="match-score">${opp.score}%</div>
              <h3 style="margin:8px 0 4px">${opp.title}</h3>
              <p style="margin:0"><strong>${opp.ngo}</strong> ‚Ä¢ ${opp.location}</p>
            </div>
            <div style="display:flex;flex-direction:column;gap:8px">
              <button class="btn btn-primary" onclick="(window._applyToOpportunity ? window._applyToOpportunity(${opp.id}, false) : alert('Apply (demo)'))">Apply</button>
              <button class="btn btn-primary" style="${canBoost ? '' : 'opacity:0.5;pointer-events:none;'}" onclick="(window._applyToOpportunity ? window._applyToOpportunity(${opp.id}, true) : alert('Boost (demo)'))">Apply & Boost (‚àí1 vToken)</button>
              <button class="btn btn-secondary" onclick="(window._bookmarkOpportunity ? window._bookmarkOpportunity(${opp.id}) : alert('Save (demo)'))">Save</button>
            </div>
          </div>
          <p style="margin-top:12px;color:var(--text-secondary)">${opp.description}</p>
        `;
        container.appendChild(card);
      });

      // header updates
      $id('userName').textContent = currentUser.name || currentUser.username || currentUser.email || 'User';
      $id('tokenCount').textContent = currentUser.tokens != null ? currentUser.tokens : 0;
      $id('dashboardMessage').textContent = currentUser.role === 'volunteer' ? `Found ${opportunities.filter(o => o.score > 50).length} great matches for your skills in ${currentUser.location || currentUser.operatingZone || 'your area'}!` : 'Manage your volunteer opportunities and track impact.';
      $id('navLinks').innerHTML = `<a href="#features">Features</a><a href="#how">How it works</a><span style="background:var(--success);color:#fff;padding:6px 10px;border-radius:12px">${(currentUser.role||'VOL').toUpperCase()}</span><a class="cta" href="#" onclick="logout()">Logout</a>`;

      // show dashboard, hide main and onboard
      $id('mainContent').style.display = 'none';
      $id('onboard').style.display = 'none';
      $id('signin').classList.add('hidden');
      $id('dashboard').classList.add('show');
      $id('dashboard').style.display = 'block';
    }

    function renderDashboard() {
      // if firebase has populated localStorage, render from it; otherwise use currentUser
      renderDashboardFromLocal();
    }

    // -------------------------
    // Profile modal handlers (global)
    // -------------------------
    window.openProfileEditor = function() {
      const stored = loadLocalProfile() || {};
      $id('profileModalBackdrop').style.display = 'flex';
      $id('editName').value = stored.name || stored.username || '';
      $id('editLocation').value = stored.location || '';
      $id('editSkills').value = (stored.skills || []).join(',');
    };

    window.closeProfileEditor = function() { $id('profileModalBackdrop').style.display = 'none'; };

    window.saveProfileEdits = async function() {
      const name = $id('editName').value.trim();
      const location = $id('editLocation').value.trim();
      const skills = $id('editSkills').value.split(',').map(s => s.trim()).filter(Boolean);

      if (window._saveProfileEdits) {
        // call Firebase-backed save (module exposes it)
        await window._saveProfileEdits({ name, location, skills });
      } else {
        const stored = loadLocalProfile() || {};
        stored.name = name; stored.location = location; stored.skills = skills;
        saveLocalProfile(stored);
        showNotification('Profile saved (local)', 'success');
      }
      closeProfileEditor();
      renderDashboardFromLocal();
    };

    // -------------------------
    // Logout (works with Firebase or local)
    // -------------------------
    window.logout = async function() {
      if (window.firebaseSignOut) {
        try { await window.firebaseSignOut(); } catch (e) { console.warn('firebase logout error', e); }
      }
      localStorage.removeItem('aeroviaUser');
      currentUser = null;
      $id('dashboard').style.display = 'none';
      $id('signin').classList.remove('hidden');
      $id('onboard').style.display = 'none';
      $id('mainContent').style.display = 'block';
      showNotification('Logged out', 'success');
    };

    // -------------------------
    // Utility: show landing / sign-in
    // -------------------------
    function showLanding() { window.scrollTo({ top: 0, behavior: 'smooth' }); $id('signin').classList.remove('hidden'); $id('onboard').style.display = 'none'; $id('mainContent').style.display = 'block'; $id('dashboard').style.display = 'none'; }
    function showSignin() { $id('signin').scrollIntoView({ behavior: 'smooth' }); }
    function scrollToHow() { $id('how').scrollIntoView({ behavior: 'smooth' }); }
  </script>

  <!-- -----------------------
       Firebase module script (full, explicit)
       - modular v9
       - auth + firestore
       - username reservation transaction
       - onboarding integration (operating zone + NGO)
       - vToken transactional spend (apply & boost)
       - bookmark & profile edits
       ----------------------- -->
  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAnalytics } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-analytics.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import {
      getFirestore,
      doc,
      getDoc,
      setDoc,
      runTransaction,
      serverTimestamp,
      collection,
      getDocs,
      addDoc
    } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    // Your Firebase config (kept from your snippet)
    const firebaseConfig = {
      apiKey: "AIzaSyD0I5r9LVAUZAnQExJSctFxMwqZjq9xDAE",
      authDomain: "aerovia-b630f.firebaseapp.com",
      projectId: "aerovia-b630f",
      storageBucket: "aerovia-b630f.firebasestorage.app",
      messagingSenderId: "521368920800",
      appId: "1:521368920800:web:cf66905b48881517e3e685",
      measurementId: "G-70VRBVN5G5"
    };

    let app;
    if (!getApps().length) {
      app = initializeApp(firebaseConfig);
      try { getAnalytics(app); } catch (e) { /* analytics may fail in some envs */ }
    } else {
      app = getApp();
    }

    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    // expose sign-out for the non-module UI
    window.firebaseSignOut = async () => {
      try { await signOut(auth); } catch (err) { console.warn('firebaseSignOut error', err); throw err; }
    };
    window.firebaseAuth = auth;

    // Utility: slugify and candidate generator (repeat here for module-scope)
    function slugifyName(name) {
      return (name || 'user').toLowerCase().replace(/[^a-z0-9]+/g, '-').replace(/^-+|-+$/g, '').slice(0, 24);
    }
    function makeCandidate(displayName) {
      const base = slugifyName((displayName || '').split(' ')[0] || displayName || 'user');
      const rand = Math.floor(100 + Math.random() * 900);
      return `${base}${rand}`;
    }

    // Reserve username + create user doc transactionally
    async function reserveUsernameAndCreateUser(uid, username, profileData = {}) {
      const usernameRef = doc(db, 'usernames', username);
      const userRef = doc(db, 'users', uid);

      return await runTransaction(db, async (tx) => {
        const unameSnap = await tx.get(usernameRef);
        if (unameSnap.exists()) throw new Error('username-already-taken');
        tx.set(usernameRef, { uid, createdAt: serverTimestamp() });

        const userSnap = await tx.get(userRef);
        const now = serverTimestamp();
        if (!userSnap.exists()) {
          tx.set(userRef, {
            uid,
            username,
            email: profileData.email || '',
            name: profileData.name || '',
            photoURL: profileData.photoURL || '',
            role: profileData.role || 'volunteer',
            skills: profileData.skills || ['teamwork'],
            location: profileData.location || 'India',
            tokens: profileData.tokens != null ? profileData.tokens : 10,
            operatingZone: profileData.operatingZone || '',
            preferredNgo: profileData.preferredNgo || null,
            createdAt: now,
            lastSeen: now
          });
        } else {
          tx.set(userRef, {
            username,
            lastSeen: now,
            operatingZone: profileData.operatingZone || undefined,
            preferredNgo: profileData.preferredNgo || undefined
          }, { merge: true });
        }
        return true;
      });
    }
    window.reserveUsernameAndCreateUser = reserveUsernameAndCreateUser;

    // Load opportunities from Firestore if present
    async function loadOpportunitiesFromFirestore() {
      try {
        const snaps = await getDocs(collection(db, 'opportunities'));
        if (!snaps.empty) {
          const docs = snaps.docs.map(d => {
            const data = d.data();
            return { id: data._localId || d.id, title: data.title, ngo: data.ngo, location: data.location, skills: data.skills || [], description: data.description || '' };
          });
          // override local opportunities with remote ones
          window.opportunities = docs;
        }
      } catch (err) {
        console.warn('loadOpportunitiesFromFirestore error', err);
      }
    }
    window.loadOpportunitiesFromFirestore = loadOpportunitiesFromFirestore;

    // Apply to opportunity (transactional vToken spend + application creation)
    async function _applyToOpportunity(oppId, boost) {
      const uid = auth.currentUser ? auth.currentUser.uid : JSON.parse(localStorage.getItem('aeroviaUser') || '{}').id;
      if (!uid) { alert('Please sign in'); return; }
      try {
        await runTransaction(db, async (tx) => {
          const uRef = doc(db, 'users', uid);
          const uSnap = await tx.get(uRef);
          if (!uSnap.exists()) throw new Error('no-user');
          const uData = uSnap.data();
          if (boost) {
            const tokens = uData.tokens || 0;
            if (tokens < 1) throw new Error('no-tokens');
            tx.update(uRef, { tokens: tokens - 1 });
          }
          const appRef = doc(collection(db, 'applications'));
          tx.set(appRef, { uid, oppId, boosted: !!boost, createdAt: serverTimestamp(), status: 'applied' });
        });
        // update localStorage tokens if present
        const stored = JSON.parse(localStorage.getItem('aeroviaUser') || '{}');
        if (stored && stored.tokens != null && boost) {
          stored.tokens = Math.max(0, stored.tokens - 1);
          localStorage.setItem('aeroviaUser', JSON.stringify(stored));
          const tc = document.getElementById('tokenCount'); if (tc) tc.textContent = stored.tokens;
        }
        alert('Application submitted' + (boost ? ' (boost used)' : ''));
      } catch (err) {
        console.error('apply error', err);
        if (err.message === 'no-tokens') alert('Not enough vTokens');
        else alert('Could not apply, try again');
      }
    }
    window._applyToOpportunity = _applyToOpportunity;

    // Bookmark
    async function _bookmarkOpportunity(oppId) {
      const uid = auth.currentUser ? auth.currentUser.uid : JSON.parse(localStorage.getItem('aeroviaUser') || '{}').id;
      if (!uid) { alert('Please sign in'); return; }
      try {
        await setDoc(doc(db, 'bookmarks', `${uid}_${oppId}`), { uid, oppId, createdAt: serverTimestamp() });
        alert('Saved to bookmarks');
      } catch (err) {
        console.error('bookmark error', err);
        alert('Could not save bookmark');
      }
    }
    window._bookmarkOpportunity = _bookmarkOpportunity;

    // Save profile edits
    async function _saveProfileEdits({ name, location, skills }) {
      const uid = auth.currentUser ? auth.currentUser.uid : JSON.parse(localStorage.getItem('aeroviaUser') || '{}').id;
      if (!uid) {
        const stored = JSON.parse(localStorage.getItem('aeroviaUser') || '{}');
        stored.name = name; stored.location = location; stored.skills = skills;
        localStorage.setItem('aeroviaUser', JSON.stringify(stored));
        showNotification('Profile updated (local)', 'success');
        return;
      }
      try {
        await setDoc(doc(db, 'users', uid), { name, location, skills, lastSeen: serverTimestamp() }, { merge: true });
        const snap = await getDoc(doc(db, 'users', uid));
        if (snap.exists()) localStorage.setItem('aeroviaUser', JSON.stringify(snap.data()));
        showNotification('Profile updated', 'success');
      } catch (err) {
        console.error(err);
        showNotification('Could not save profile', 'error');
      }
    }
    window._saveProfileEdits = _saveProfileEdits;

    // Create opportunity (NGO)
    async function _createOpportunity({ title, location, skills, desc }) {
      if (!auth.currentUser) { showNotification('Sign in as NGO to create opportunities', 'error'); return; }
      try {
        await addDoc(collection(db, 'opportunities'), { title, location, skills: skills || [], description: desc || '', ngo: auth.currentUser.displayName || 'NGO', createdAt: serverTimestamp(), _localId: Date.now().toString() });
        await loadOpportunitiesFromFirestore();
        showNotification('Opportunity created', 'success');
      } catch (err) {
        console.error(err);
        showNotification('Could not create opportunity', 'error');
      }
    }
    window._createOpportunity = _createOpportunity;

    // Hook: Google sign-in button
    const gBtn = document.getElementById('googleSignInBtn');
    if (gBtn) {
      gBtn.addEventListener('click', async () => {
        gBtn.disabled = true; gBtn.classList.add('loading');
        try {
          await signInWithPopup(auth, provider);
          // onAuthStateChanged will handle next steps
        } catch (err) {
          console.error('Google sign-in error', err);
          showNotification('Google sign-in failed: ' + (err?.message || err), 'error');
        } finally {
          gBtn.disabled = false; gBtn.classList.remove('loading');
        }
      });
    }

    // On auth state change: show onboarding if necessary, otherwise map profile and show dashboard
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        await loadOpportunitiesFromFirestore();
        const userRef = doc(db, 'users', user.uid);
        const snap = await getDoc(userRef);
        if (!snap.exists() || !snap.data().username || !snap.data().operatingZone) {
          window._firebaseUserForOnboard = user;
          // prefill and show onboarding
          document.getElementById('signin').classList.add('hidden');
          document.getElementById('mainContent').style.display = 'none';
          document.getElementById('onboard').style.display = 'block';
          const suggestion = makeCandidate(user.displayName || user.email || 'user');
          const ui = document.getElementById('usernameInput'); if (ui) ui.value = suggestion;
          document.getElementById('usernameFeedback').textContent = '';
          return;
        } else {
          // map
          const d = snap.data();
          const mapped = {
            id: d.uid || user.uid,
            email: d.email || user.email,
            role: d.role || 'volunteer',
            name: d.name || user.displayName || user.email.split('@')[0],
            skills: d.skills || ['teamwork'],
            location: d.location || 'India',
            tokens: d.tokens || 0,
            username: d.username,
            operatingZone: d.operatingZone || '',
            preferredNgo: d.preferredNgo || null
          };
          localStorage.setItem('aeroviaUser', JSON.stringify(mapped));
          // short delay then render dashboard
          setTimeout(() => {
            try { renderDashboardFromLocal(); } catch (e) { console.warn(e); }
          }, 200);
        }
      } catch (err) {
        console.error('onAuthStateChanged error', err);
        showNotification('Sign-in succeeded but profile check failed', 'error');
      }
    });
  </script>
</body>
</html>
