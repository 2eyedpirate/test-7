<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Aerovia — Where Purpose Meets Partnership</title>
  <meta name="description" content="Aerovia - AI-powered volunteer matching platform connecting NGOs with skilled volunteers">
  <style>
    /* ---------- Original design CSS (kept intact) ---------- */
    @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap');

    :root {
      --primary: #0A84FF;
      --primary-dark: #0066CC;
      --text-primary: #1D1D1F;
      --text-secondary: #6E6E73;
      --text-tertiary: #86868B;
      --bg-primary: #FFFFFF;
      --bg-secondary: #F5F5F7;
      --bg-glass: rgba(255, 255, 255, 0.72);
      --border: rgba(0, 0, 0, 0.08);
      --shadow-sm: 0 2px 8px rgba(0, 0, 0, 0.04);
      --shadow-md: 0 4px 24px rgba(0, 0, 0, 0.08);
      --shadow-lg: 0 12px 48px rgba(0, 0, 0, 0.12);
      --success: #34C759;
    }

    * { box-sizing: border-box; margin: 0; padding: 0; }
    html { scroll-behavior: smooth; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
    body { font-family: 'Inter', system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Arial; color: var(--text-primary); background: var(--bg-primary); line-height: 1.6; }

    nav { position: fixed; left: 0; right: 0; top: 0; background: var(--bg-glass); backdrop-filter: saturate(180%) blur(20px); border-bottom: 1px solid var(--border); z-index: 1000; }
    .nav-container { max-width: 1280px; margin: 0 auto; padding: 0 20px; display:flex; align-items:center; justify-content:space-between; height:52px; }
    .nav-logo { font-weight:600; font-size:20px; color:var(--text-primary); text-decoration:none; }
    .nav-links { display:flex; gap:20px; align-items:center; }

    .container { max-width: 1100px; margin: 0 auto; padding: 120px 20px 80px; }
    .signin-card { background: var(--bg-secondary); border: 1px solid var(--border); border-radius: 16px; padding: 32px; box-shadow: var(--shadow-md); }
    .btn { padding: 12px 18px; border-radius: 10px; border: none; cursor: pointer; font-weight: 600; }
    .btn-primary { background: var(--primary); color: #fff; }
    .btn-secondary { background: transparent; border: 1.5px solid var(--border); color: var(--primary); }

    .signin-section { padding: 80px 20px; max-width: 520px; margin: 0 auto; }
    .input-group { margin-bottom: 14px; }
    input, select, textarea { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid var(--border); background: var(--bg-primary); color: var(--text-primary); }

    .ngo-list { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px,1fr)); gap: 12px; margin-top: 12px; }
    .ngo-card { background: var(--bg-primary); border: 1px solid var(--border); padding: 12px; border-radius: 10px; cursor: pointer; display:flex; flex-direction:column; gap:6px; }
    .ngo-card.selected { outline:2px solid var(--primary); box-shadow: var(--shadow-sm); }

    .dashboard { display: none; padding: 100px 20px; max-width: 1100px; margin: 0 auto; }
    .dashboard.show { display: block; }

    .modal-backdrop { position: fixed; inset: 0; background: rgba(0,0,0,0.4); display: none; align-items:center; justify-content:center; z-index: 2000; }
    .modal { background: var(--bg-primary); padding: 16px; border-radius: 12px; width: 100%; max-width: 520px; border: 1px solid var(--border); }

    .notification { position: fixed; top: 20px; right: 20px; padding: 12px 18px; border-radius: 10px; transform: translateX(300px); transition: all .28s; box-shadow: var(--shadow-lg); z-index: 1200; }
    .notification.show { transform: translateX(0); }
    .notification.success { background: var(--success); color: white; }
  </style>
</head>
<body>
  <nav>
    <div class="nav-container">
      <a class="nav-logo" href="#" onclick="showLanding()">Aerovia</a>
      <div class="nav-links" id="navLinks">
        <a href="#features">Features</a>
        <a href="#how">How it works</a>
        <a class="cta" href="#signin" onclick="showSignin()">Get Started</a>
      </div>
    </div>
  </nav>

  <div id="notification" class="notification" style="display:none"></div>

  <main>
    <section class="container" id="mainContent">
      <div style="text-align:center;margin-bottom:28px">
        <h1 style="font-size:36px;margin-bottom:12px">Where purpose<br>meets partnership</h1>
        <p style="max-width:760px;color:var(--text-secondary);margin:0 auto 20px">An intelligent platform that connects NGOs with volunteers through thoughtful, AI-powered matching.</p>
      </div>

      <!-- Sign-in -->
      <section class="signin-section" id="signin">
        <div class="signin-card">
          <h2 style="text-align:center;margin-bottom:6px">Join Aerovia</h2>
          <p style="text-align:center;color:var(--text-secondary);margin-bottom:14px">Start making impact today — free forever</p>

          <form id="authForm">
            <div class="input-group">
              <label for="email">Email</label>
              <input id="email" type="email" placeholder="you@example.com" />
            </div>
            <div class="input-group">
              <label for="password">Password</label>
              <input id="password" type="password" placeholder="Enter your password" minlength="6" />
            </div>
            <div style="display:flex;gap:8px;margin-bottom:12px">
              <button class="btn btn-primary" id="submitBtn" type="submit" style="flex:1">Get started</button>
              <button type="button" class="btn btn-secondary" onclick="quickLogin('volunteer')">Demo Volunteer</button>
            </div>
          </form>

          <div style="text-align:center;margin:12px 0;color:var(--text-tertiary)">— or —</div>

          <div>
            <button id="googleSignInBtn" class="btn btn-primary" style="width:100%;display:flex;align-items:center;justify-content:center;gap:8px">
              <img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:18px;height:18px"> Continue with Google
            </button>
          </div>
        </div>
      </section>

      <!-- Onboarding: operating zone + NGO picker (shown after Google sign-in if needed) -->
      <section class="signin-section" id="onboard" style="display:none;">
        <div class="signin-card">
          <h2 style="margin-bottom:8px">Select Your Operating Zone</h2>
          <p style="color:var(--text-secondary);margin-bottom:12px">Choose the city where you prefer to volunteer and pick an NGO to follow.</p>

          <div style="margin-bottom:12px">
            <select id="citySelect" onchange="loadNGOs()" style="width:100%;padding:12px;border-radius:8px;border:1px solid var(--border)">
              <option value="">-- Choose a City --</option>
              <option>Delhi</option><option>Mumbai</option><option>Bengaluru</option><option>Hyderabad</option>
              <option>Chennai</option><option>Kolkata</option><option>Pune</option><option>Ahmedabad</option>
              <option>Jaipur</option><option>Kochi</option>
            </select>
          </div>

          <div id="ngoList" class="ngo-list"></div>
          <div id="ngoSelectionFeedback" style="margin-top:10px;color:var(--text-tertiary)">Pick an NGO to follow/associate with your profile.</div>

          <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:14px">
            <button id="onboardSkipBtn" class="btn btn-secondary">Skip</button>
            <button id="onboardSaveBtn" class="btn btn-primary">Continue</button>
          </div>
        </div>
      </section>
    </section>

    <!-- Dashboard (hidden until profile ready) -->
    <section id="dashboard" class="dashboard" style="display:none">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:14px">
        <div>
          <h2>Welcome, <span id="userName">User</span></h2>
          <div id="dashboardMessage" style="color:var(--text-secondary)"></div>
        </div>
        <div style="display:flex;align-items:center;gap:12px">
          <div style="background:var(--bg-secondary);padding:8px 12px;border-radius:10px;border:1px solid var(--border)">vTokens: <strong id="tokenCount">0</strong></div>
          <button class="btn btn-secondary" onclick="openProfileEditor()">Edit profile</button>
          <button class="btn btn-secondary" onclick="logout()">Logout</button>
        </div>
      </div>

      <div id="matchesContainer"></div>
    </section>
  </main>

  <!-- Profile editor modal -->
  <div id="profileModalBackdrop" class="modal-backdrop">
    <div class="modal">
      <h3>Edit profile</h3>
      <div style="margin-top:8px"><label style="color:var(--text-secondary)">Name</label><input id="editName" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
      <div style="margin-top:8px"><label style="color:var(--text-secondary)">Location</label><input id="editLocation" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
      <div style="margin-top:8px"><label style="color:var(--text-secondary)">Skills (comma separated)</label><input id="editSkills" placeholder="teaching,writing" style="width:100%;padding:8px;border-radius:8px;border:1px solid var(--border)"></div>
      <div style="display:flex;justify-content:flex-end;gap:8px;margin-top:12px"><button class="btn btn-secondary" onclick="closeProfileEditor()">Cancel</button><button class="btn btn-primary" onclick="saveProfileEdits()">Save</button></div>
    </div>
  </div>

  <footer style="text-align:center;padding:40px 20px;border-top:1px solid var(--border);color:var(--text-tertiary)">
    © 2026 Aerovia — Advancing SDG 17
  </footer>

  <!-- NGO dataset -->
  <script>
    window.ngoData = {
      Delhi: [{name:"Goonj",focus:"Urban Poverty & Clothing"},{name:"Smile Foundation",focus:"Education & Children"},{name:"CRY",focus:"Child Rights"},{name:"Pratham",focus:"Education"},{name:"Teach For India",focus:"Education"},{name:"Action Against Hunger",focus:"Nutrition"},{name:"HelpAge India",focus:"Elderly Care"},{name:"Uday Foundation",focus:"Healthcare"},{name:"Deepalaya",focus:"Community Development"},{name:"Azad Foundation",focus:"Women Empowerment"}],
      Mumbai: [{name:"Akanksha Foundation",focus:"Education"},{name:"Beach Please",focus:"Environment"},{name:"Nanhi Kali",focus:"Girl Education"},{name:"Reality Gives",focus:"Youth Development"},{name:"Sneha",focus:"Women Safety"},{name:"Apnalaya",focus:"Urban Slums"},{name:"Magic Bus",focus:"Life Skills"},{name:"Aseema",focus:"Schooling"},{name:"Muskaan",focus:"Child Welfare"},{name:"Salaam Bombay",focus:"Adolescent Support"}],
      Bengaluru: [{name:"Make A Difference",focus:"Child Welfare"},{name:"SayTrees",focus:"Afforestation"},{name:"Akshaya Patra",focus:"Midday Meals"},{name:"Dream A Dream",focus:"Youth Development"},{name:"Hasiru Dala",focus:"Waste Workers"},{name:"Swasthi",focus:"Public Health"},{name:"The/Nudge",focus:"Poverty Alleviation"},{name:"Samatva",focus:"Social Inclusion"},{name:"Reap Benefit",focus:"Civic Issues"},{name:"Karunashraya",focus:"Palliative Care"}],
      Hyderabad: [{name:"Helping Hands Foundation",focus:"Disaster Relief"},{name:"U&I Trust",focus:"Education"},{name:"Sphoorti",focus:"Child Care"},{name:"SAFA",focus:"Women Development"},{name:"Deccan Development Society",focus:"Sustainable Agriculture"},{name:"Roshni Counselling",focus:"Mental Health"},{name:"Manzil",focus:"Education"},{name:"Asha Foundation",focus:"Healthcare"},{name:"YouWeCan",focus:"Youth Empowerment"},{name:"Helping Hand",focus:"Community Aid"}],
      Chennai: [{name:"Bhumi",focus:"Youth Volunteering"},{name:"Hand in Hand",focus:"Livelihoods"},{name:"Udavum Karangal",focus:"Orphan Care"},{name:"Sneha",focus:"Emotional Support"},{name:"Aravind Eye Care",focus:"Healthcare"},{name:"Rural Education Development",focus:"Education"},{name:"The Banyan",focus:"Mental Health"},{name:"ExNoRa",focus:"Environment"},{name:"Agastya Foundation",focus:"Science Education"},{name:"Sevalaya",focus:"Rural Development"}],
      Kolkata: [{name:"CINI",focus:"Child Nutrition"},{name:"Prayasam",focus:"Mental Health"},{name:"Calcutta Rescue",focus:"Healthcare"},{name:"Hope Foundation",focus:"Street Children"},{name:"Sanlaap",focus:"Anti-Trafficking"},{name:"Child in Need Institute",focus:"Health & Education"},{name:"Anudip",focus:"Digital Skills"},{name:"Tiljala Shed",focus:"Slum Education"},{name:"Ek Tara",focus:"Music Education"},{name:"Prayas India",focus:"Social Reform"}],
      Pune: [{name:"Door Step School",focus:"Education"},{name:"Jeevitnadi",focus:"River Conservation"},{name:"Teach For India",focus:"Education"},{name:"Shelter Associates",focus:"Urban Housing"},{name:"Mitra",focus:"Disaster Response"},{name:"BAIF",focus:"Rural Livelihoods"},{name:"Deep Griha",focus:"Community Welfare"},{name:"Grampari",focus:"Women Empowerment"},{name:"Jnanaprabodhini",focus:"Youth Development"},{name:"Navjeevan",focus:"Rehabilitation"}],
      Ahmedabad: [{name:"Manav Sadhna",focus:"Community Development"},{name:"Blind People’s Association",focus:"Disability Support"},{name:"SEWA",focus:"Women Workers"},{name:"Self Employed Women’s Association",focus:"Livelihoods"},{name:"Prayas",focus:"Education"},{name:"Sewa Rural",focus:"Healthcare"},{name:"Eklavya",focus:"Child Education"},{name:"Gujarat Forum",focus:"Urban Issues"},{name:"Sahaj",focus:"Social Justice"},{name:"Janvikas",focus:"Tribal Development"}],
      Jaipur: [{name:"Barefoot College",focus:"Rural Development"},{name:"Apna Ghar",focus:"Women Safety"},{name:"I-India",focus:"Child Education"},{name:"Gramin Vikas",focus:"Village Development"},{name:"Seva Mandir",focus:"Tribal Welfare"},{name:"Jan Sahas",focus:"Anti-Bonded Labour"},{name:"URMUL",focus:"Livelihoods"},{name:"Sankalp",focus:"Skill Training"},{name:"Smile Society",focus:"Education"},{name:"Prayas Trust",focus:"Social Upliftment"}],
      Kochi: [{name:"SEED",focus:"Sustainable Development"},{name:"CarePlus",focus:"Healthcare Access"},{name:"Thanal",focus:"Environment"},{name:"Rajagiri Outreach",focus:"Community Services"},{name:"Sanjeevani",focus:"Palliative Care"},{name:"Kudumbashree",focus:"Women Empowerment"},{name:"Sneha Bhavan",focus:"Orphan Care"},{name:"Rebuild Kerala",focus:"Disaster Recovery"},{name:"Green Army",focus:"Environmental Action"},{name:"Hope Foundation Kerala",focus:"Child Welfare"}]
    };
    window.__selectedNgoForOnboard = null;
  </script>

  <!-- FULL client + firebase code (keeps previous functionality and ensures onboarding is shown after Google login if operatingZone missing) -->
  <script>
    // short helpers
    const $ = (id) => document.getElementById(id);

    function showNotification(message, type='success') {
      const n = $('notification');
      n.textContent = message;
      n.className = `notification ${type} show`;
      n.style.display = 'block';
      setTimeout(() => { n.classList.remove('show'); n.style.display = 'none'; }, 3500);
    }

    // Local state
    let currentUser = null;
    let opportunities = [
      { id: 1, title: "Weekend Tree Planting - Delhi", ngo: "Green Earth Foundation", location: "Delhi", skills: ["teamwork","outdoor"], description: "Join monthly tree planting events." },
      { id: 2, title: "Math Tutoring Mentor - Mumbai", ngo: "Teach For India", location: "Mumbai", skills: ["teaching"], description: "2 hours/week tutoring." }
    ];

    // Load local profile but do NOT auto-render dashboard if Firebase may sign-in.
    function loadLocalProfile() { try { return JSON.parse(localStorage.getItem('aeroviaUser')||'null'); } catch(e){ return null; } }

    function saveLocalProfile(p) { localStorage.setItem('aeroviaUser', JSON.stringify(p)); currentUser = p; }

    // Wire UI
    document.addEventListener('DOMContentLoaded', () => {
      // init animations omitted for brevity — kept from earlier (not shown)
      // wire auth form
      $('authForm')?.addEventListener('submit', handleLocalAuth);
      $('generateUsernameBtn')?.addEventListener('click', () => {
        const suggestion = (currentUser && currentUser.name) ? currentUser.name.split(' ')[0].toLowerCase().replace(/[^a-z0-9]+/g,'-') + Math.floor(100+Math.random()*900) : 'user' + Math.floor(100+Math.random()*900);
        $('usernameInput').value = suggestion; $('usernameFeedback').textContent = 'New suggestion generated';
      });
      $('onboardSaveBtn')?.addEventListener('click', onboardSaveHandler);
      $('onboardSkipBtn')?.addEventListener('click', onboardSkipHandler);
      // if local profile exists, show onboarding for demo if missing operatingZone
      const local = loadLocalProfile();
      if (local && (!local.username || !local.operatingZone)) {
        // show onboard for local/demo accounts
        $('signin').classList.add('hidden');
        $('onboard').style.display = 'block';
        $('mainContent').style.display = 'none';
      } else if (local) {
        currentUser = local;
        renderDashboardFromLocal();
      }
    });

    function handleLocalAuth(e){
      e.preventDefault();
      const email = $('email').value.trim();
      const pwd = $('password').value;
      const demoVolunteer = { id:'demo-vol', email:'volunteer@aerovia.com', role:'volunteer', name:'Priya Sharma', skills:['teaching','teamwork'], location:'Delhi', tokens:10 };
      const demoNGO = { id:'demo-ngo', email:'ngo@aerovia.com', role:'ngo', name:'Green Earth Foundation', skills:['fundraising'], location:'Delhi', tokens:0 };
      let user = null;
      if (email === demoVolunteer.email && pwd==='demo123') user = demoVolunteer;
      else if (email === demoNGO.email && pwd==='demo123') user = demoNGO;
      else user = { id: Date.now().toString(), email, role: email.includes('ngo')?'ngo':'volunteer', name: email.split('@')[0], skills:['teamwork'], location:'India', tokens:5 };
      saveLocalProfile(user);
      showNotification('Signed in (local): ' + user.name);
      if (!user.username || !user.operatingZone) {
        $('signin').classList.add('hidden'); $('onboard').style.display = 'block'; $('mainContent').style.display = 'none';
      } else {
        renderDashboardFromLocal();
      }
    }

    window.quickLogin = (role) => {
      const user = role === 'volunteer' ? { id:'demo-vol', email:'demo@volunteer.com', role:'volunteer', name:'Demo Volunteer', skills:['teaching','teamwork'], location:'Delhi', tokens:10 } : { id:'demo-ngo', email:'demo@ngo.com', role:'ngo', name:'Demo NGO', skills:['fundraising'], location:'Mumbai', tokens:0 };
      saveLocalProfile(user);
      showNotification('Logged in: ' + user.name);
      if (!user.username || !user.operatingZone) {
        $('signin').classList.add('hidden'); $('onboard').style.display = 'block'; $('mainContent').style.display = 'none';
      } else renderDashboardFromLocal();
    };

    // NGO list rendering
    window.loadNGOs = function(){
      const city = $('citySelect').value;
      const ngoList = $('ngoList');
      window.__selectedNgoForOnboard = null;
      ngoList.innerHTML = '';
      if (!city) { ngoList.innerHTML = '<div style="color:var(--text-tertiary)">Choose a city to see NGOs</div>'; return; }
      const list = (window.ngoData && window.ngoData[city]) || [];
      list.forEach(n => {
        const card = document.createElement('div');
        card.className = 'ngo-card';
        card.tabIndex = 0;
        card.innerHTML = `<h4>${n.name}</h4><p>${n.focus}</p>`;
        card.addEventListener('click', ()=>{ ngoList.querySelectorAll('.ngo-card').forEach(c=>c.classList.remove('selected')); card.classList.add('selected'); window.__selectedNgoForOnboard = n; $('ngoSelectionFeedback').textContent = 'Selected: '+n.name+' — '+n.focus; });
        card.addEventListener('keypress', e=>{ if(e.key==='Enter') card.click(); });
        ngoList.appendChild(card);
      });
    };

    async function onboardSaveHandler(){
      const city = $('citySelect').value || '';
      const ngo = window.__selectedNgoForOnboard || null;
      // If Firebase helper available, use it (this will be set by the module)
      if (window.reserveUsernameAndCreateUser && window._firebaseUserForOnboard) {
        try {
          const fu = window._firebaseUserForOnboard;
          const username = $('usernameInput').value.trim() || makeCandidate(fu.displayName || fu.email || 'user');
          await window.reserveUsernameAndCreateUser(fu.uid, username, { email: fu.email || '', name: fu.displayName || '', tokens: 10, operatingZone: city, preferredNgo: ngo });
          // Firestore onAuthStateChanged will map profile to localStorage and trigger dashboard render; ensure we hide local views
          $('onboard').style.display = 'none'; showNotification('Profile saved to Firebase — redirecting', 'success');
        } catch (e) {
          console.error(e);
          if (e.message === 'username-already-taken') $('usernameFeedback').textContent = 'That username is taken — try another.';
          else $('usernameFeedback').textContent = 'Could not save profile to Firebase.';
        }
      } else {
        const stored = loadLocalProfile() || {};
        stored.username = $('usernameInput').value.trim() || stored.username || ('user-'+Math.floor(Math.random()*10000));
        stored.operatingZone = city;
        stored.preferredNgo = ngo;
        stored.tokens = stored.tokens != null ? stored.tokens : 10;
        saveLocalProfile(stored);
        showNotification('Profile saved locally', 'success');
        $('onboard').style.display = 'none';
        renderDashboardFromLocal();
      }
    }

    async function onboardSkipHandler(){
      if (window.reserveUsernameAndCreateUser && window._firebaseUserForOnboard) {
        try {
          const fu = window._firebaseUserForOnboard;
          const fallback = `${slugifyName(fu.displayName||fu.email||'user')}-${fu.uid.slice(0,6)}`;
          await window.reserveUsernameAndCreateUser(fu.uid, fallback, { email: fu.email || '', name: fu.displayName || '', tokens: 5 });
          showNotification('Profile created with fallback username', 'success');
          // Firestore handler will map profile and render dashboard
        } catch (e) { console.error(e); showNotification('Skip failed', 'error'); }
      } else {
        const stored = loadLocalProfile() || {};
        stored.username = stored.username || ('user-'+Math.floor(Math.random()*10000));
        stored.tokens = stored.tokens != null ? stored.tokens : 5;
        saveLocalProfile(stored);
        $('onboard').style.display = 'none';
        renderDashboardFromLocal();
      }
    }

    // Dashboard rendering
    function calculateMatches() {
      if (!currentUser) currentUser = loadLocalProfile() || {};
      opportunities.forEach(opp => {
        let score = 0;
        const skillMatches = (currentUser.skills || []).filter(s => opp.skills.includes(s));
        score += Math.min(skillMatches.length * 25, 50);
        if ((currentUser.location || '').toLowerCase().includes(opp.location.toLowerCase()) || opp.location === 'Remote') score += 30;
        if (currentUser.role === 'volunteer') score += 20;
        opp.score = Math.round(score);
        opp.reasoning = `${skillMatches.length} skill matches • ${opp.location} opportunity`;
      });
      opportunities.sort((a,b)=>b.score - a.score);
    }

    function renderDashboardFromLocal(){
      const stored = loadLocalProfile() || {};
      currentUser = stored;
      calculateMatches();
      const container = $('matchesContainer'); container.innerHTML = '';
      const zone = currentUser.operatingZone || '';
      const list = opportunities.filter(o => !zone || o.location.toLowerCase().includes(zone.toLowerCase()) || o.location === 'Remote');
      list.forEach(opp => {
        const card = document.createElement('div'); card.className = 'match-card';
        const canBoost = (currentUser.tokens || 0) > 0;
        card.innerHTML = `<div style="display:flex;justify-content:space-between;align-items:center">
          <div><div class="match-score">${opp.score}%</div><h3 style="margin:8px 0 4px">${opp.title}</h3><p style="margin:0"><strong>${opp.ngo}</strong> • ${opp.location}</p></div>
          <div style="display:flex;flex-direction:column;gap:8px">
            <button class="btn btn-primary" onclick="(window._applyToOpportunity ? window._applyToOpportunity(${opp.id}, false) : alert('Apply (demo)'))">Apply</button>
            <button class="btn btn-primary" style="${canBoost ? '' : 'opacity:0.5;pointer-events:none;'}" onclick="(window._applyToOpportunity ? window._applyToOpportunity(${opp.id}, true) : alert('Boost (demo)'))">Apply & Boost (−1 vToken)</button>
            <button class="btn btn-secondary" onclick="(window._bookmarkOpportunity ? window._bookmarkOpportunity(${opp.id}) : alert('Save (demo)'))">Save</button>
          </div>
        </div><p style="margin-top:12px;color:var(--text-secondary)">${opp.description}</p>`;
        container.appendChild(card);
      });
      $('userName').textContent = currentUser.name || currentUser.username || 'User';
      $('tokenCount').textContent = currentUser.tokens || 0;
      $('dashboardMessage').textContent = currentUser.role === 'volunteer' ? `Found ${opportunities.filter(o => o.score > 50).length} great matches for your skills in ${currentUser.operatingZone || currentUser.location || 'your area'}!` : 'Manage your volunteer opportunities and track impact.';
      $('navLinks').innerHTML = `<a href="#features">Features</a><a href="#how">How it works</a><span style="background:var(--success);color:#fff;padding:6px 10px;border-radius:12px">${(currentUser.role||'VOL').toUpperCase()}</span><a class="cta" href="#" onclick="logout()">Logout</a>`;
      $('mainContent').style.display = 'none'; $('signin').classList.add('hidden'); $('onboard').style.display = 'none'; $('dashboard').style.display = 'block';
    }

    // Profile modal handlers
    window.openProfileEditor = function(){ const s = loadLocalProfile() || {}; $('profileModalBackdrop').style.display = 'flex'; $('editName').value = s.name || s.username || ''; $('editLocation').value = s.location || ''; $('editSkills').value = (s.skills||[]).join(','); };
    window.closeProfileEditor = function(){ $('profileModalBackdrop').style.display = 'none'; };
    window.saveProfileEdits = async function(){ const name = $('editName').value.trim(); const location = $('editLocation').value.trim(); const skills = $('editSkills').value.split(',').map(s=>s.trim()).filter(Boolean); if(window._saveProfileEdits) { await window._saveProfileEdits({ name, location, skills }); } else { const s = loadLocalProfile() || {}; s.name = name; s.location = location; s.skills = skills; saveLocalProfile(s); showNotification('Profile saved (local)'); } closeProfileEditor(); renderDashboardFromLocal(); };

    window.logout = async function(){ if(window.firebaseSignOut){ try{ await window.firebaseSignOut(); }catch(e){ console.warn(e); } } localStorage.removeItem('aeroviaUser'); currentUser = null; $('dashboard').style.display = 'none'; $('signin').classList.remove('hidden'); $('onboard').style.display = 'none'; $('mainContent').style.display = 'block'; showNotification('Logged out'); };

    // -------------------------
    // Firebase module (modular v9) — full behavior
    // -------------------------
  </script>

  <script type="module">
    import { initializeApp, getApps, getApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getAuth, GoogleAuthProvider, signInWithPopup, signOut, onAuthStateChanged } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-auth.js";
    import { getFirestore, doc, getDoc, setDoc, runTransaction, serverTimestamp, collection, getDocs, addDoc } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-firestore.js";

    const firebaseConfig = {
      apiKey: "AIzaSyD0I5r9LVAUZAnQExJSctFxMwqZjq9xDAE",
      authDomain: "aerovia-b630f.firebaseapp.com",
      projectId: "aerovia-b630f",
      storageBucket: "aerovia-b630f.firebasestorage.app",
      messagingSenderId: "521368920800",
      appId: "1:521368920800:web:cf66905b48881517e3e685",
      measurementId: "G-70VRBVN5G5"
    };

    const app = (!getApps().length) ? initializeApp(firebaseConfig) : getApp();
    const auth = getAuth(app);
    const provider = new GoogleAuthProvider();
    const db = getFirestore(app);

    window.firebaseSignOut = async () => { try { await signOut(auth); } catch(e){ console.warn(e); throw e; } };
    window.firebaseAuth = auth;

    function slugifyName(name) { return (name||'user').toLowerCase().replace(/[^a-z0-9]+/g,'-').replace(/^-+|-+$/g,'').slice(0,24); }
    function makeCandidate(displayName) { const base = slugifyName((displayName||'').split(' ')[0]||displayName||'user'); const rand = Math.floor(100+Math.random()*900); return `${base}${rand}`; }

    async function reserveUsernameAndCreateUser(uid, username, profileData = {}) {
      const usernameRef = doc(db, 'usernames', username);
      const userRef = doc(db, 'users', uid);
      return runTransaction(db, async (tx) => {
        const unameSnap = await tx.get(usernameRef);
        if (unameSnap.exists()) throw new Error('username-already-taken');
        tx.set(usernameRef, { uid, createdAt: serverTimestamp() });

        const userSnap = await tx.get(userRef);
        const now = serverTimestamp();
        if (!userSnap.exists()) {
          tx.set(userRef, {
            uid,
            username,
            email: profileData.email || '',
            name: profileData.name || '',
            photoURL: profileData.photoURL || '',
            role: profileData.role || 'volunteer',
            skills: profileData.skills || ['teamwork'],
            location: profileData.location || 'India',
            tokens: profileData.tokens != null ? profileData.tokens : 10,
            operatingZone: profileData.operatingZone || '',
            preferredNgo: profileData.preferredNgo || null,
            createdAt: now,
            lastSeen: now
          });
        } else {
          tx.set(userRef, {
            username,
            lastSeen: now,
            operatingZone: profileData.operatingZone || undefined,
            preferredNgo: profileData.preferredNgo || undefined
          }, { merge: true });
        }
        return true;
      });
    }
    window.reserveUsernameAndCreateUser = reserveUsernameAndCreateUser;

    async function loadOpportunitiesFromFirestore() {
      try {
        const snaps = await getDocs(collection(db,'opportunities'));
        if (!snaps.empty) {
          const docs = snaps.docs.map(d => { const data = d.data(); return { id: data._localId || d.id, title: data.title, ngo: data.ngo, location: data.location, skills: data.skills || [], description: data.description || '' }; });
          window.opportunities = docs;
        }
      } catch(e) { console.warn('load opps', e); }
    }
    window.loadOpportunitiesFromFirestore = loadOpportunitiesFromFirestore;

    async function _applyToOpportunity(oppId, boost) {
      const uid = auth.currentUser ? auth.currentUser.uid : JSON.parse(localStorage.getItem('aeroviaUser')||'{}').id;
      if (!uid) { alert('Please sign in'); return; }
      try {
        await runTransaction(db, async (tx) => {
          const uRef = doc(db,'users',uid); const uSnap = await tx.get(uRef);
          if (!uSnap.exists()) throw new Error('no-user');
          const uData = uSnap.data();
          if (boost) {
            const tokens = uData.tokens || 0;
            if (tokens < 1) throw new Error('no-tokens');
            tx.update(uRef, { tokens: tokens - 1 });
          }
          const appRef = doc(collection(db,'applications')); tx.set(appRef, { uid, oppId, boosted: !!boost, createdAt: serverTimestamp(), status: 'applied' });
        });
        const stored = JSON.parse(localStorage.getItem('aeroviaUser')||'{}');
        if (stored && stored.tokens != null && boost) { stored.tokens = Math.max(0, stored.tokens - 1); localStorage.setItem('aeroviaUser', JSON.stringify(stored)); const tc = $('tokenCount'); if (tc) tc.textContent = stored.tokens; }
        alert('Application submitted' + (boost ? ' (boost used)' : ''));
      } catch(err){ console.error(err); if (err.message==='no-tokens') alert('Not enough vTokens'); else alert('Could not apply'); }
    }
    window._applyToOpportunity = _applyToOpportunity;

    async function _bookmarkOpportunity(oppId) {
      const uid = auth.currentUser ? auth.currentUser.uid : JSON.parse(localStorage.getItem('aeroviaUser')||'{}').id;
      if (!uid) { alert('Sign in to bookmark'); return; }
      try { await setDoc(doc(db,'bookmarks', `${uid}_${oppId}`), { uid, oppId, createdAt: serverTimestamp() }); alert('Saved to bookmarks'); } catch(e){ console.error(e); alert('Could not save bookmark'); }
    }
    window._bookmarkOpportunity = _bookmarkOpportunity;

    async function _saveProfileEdits({name, location, skills}) {
      const uid = auth.currentUser ? auth.currentUser.uid : JSON.parse(localStorage.getItem('aeroviaUser')||'{}').id;
      if (!uid) { const s = JSON.parse(localStorage.getItem('aeroviaUser')||'{}'); s.name=name; s.location=location; s.skills=skills; localStorage.setItem('aeroviaUser', JSON.stringify(s)); showNotification('Profile updated (local)'); return; }
      try { await setDoc(doc(db,'users',uid), { name, location, skills, lastSeen: serverTimestamp() }, { merge:true }); const snap = await getDoc(doc(db,'users',uid)); if (snap.exists()) localStorage.setItem('aeroviaUser', JSON.stringify(snap.data())); showNotification('Profile updated'); } catch(e){ console.error(e); showNotification('Could not save profile', 'error'); }
    }
    window._saveProfileEdits = _saveProfileEdits;

    // Hook google button for popup sign-in
    const gBtn = $('googleSignInBtn');
    if (gBtn) {
      gBtn.addEventListener('click', async () => {
        gBtn.disabled = true; gBtn.textContent = 'Signing in...';
        try { await signInWithPopup(auth, provider); } catch(e){ console.error(e); showNotification('Google sign-in failed', 'error'); } finally { gBtn.disabled = false; gBtn.innerHTML = `<img src="https://www.gstatic.com/firebasejs/ui/2.0.0/images/auth/google.svg" style="width:18px;height:18px"> Continue with Google`; }
      });
    }

    // onAuth state: ensure onboarding is shown when operatingZone missing (this is the critical fix)
    onAuthStateChanged(auth, async (user) => {
      if (!user) return;
      try {
        // ensure we have latest opportunities
        await loadOpportunitiesFromFirestore();
        const userRef = doc(db,'users',user.uid);
        const snap = await getDoc(userRef);

        // Show onboarding if user doc missing or missing username or missing operatingZone
        const needOnboard = (!snap.exists()) || (!snap.data().username) || (!snap.data().operatingZone);
        if (needOnboard) {
          // store firebase user for onboard save flow
          window._firebaseUserForOnboard = user;
          // hide any dashboard that may have been rendered from localStorage
          $('dashboard').style.display = 'none';
          $('dashboard').classList.remove('show');
          // show onboarding UI
          $('signin').classList.add('hidden');
          $('mainContent').style.display = 'none';
          $('onboard').style.display = 'block';
          // prefill username suggestion
          const suggestion = makeCandidate(user.displayName || user.email || 'user');
          const ui = $('usernameInput'); if (ui) ui.value = suggestion;
          const tokensDisp = $('tokensDisplay'); if (tokensDisp) tokensDisp.textContent = '10';
          $('usernameFeedback').textContent = '';
          return;
        }

        // Map Firestore user to localStorage so UI can render
        const d = snap.data();
        const mapped = {
          id: d.uid || user.uid,
          name: d.name || user.displayName || user.email.split('@')[0],
          email: d.email || user.email,
          role: d.role || 'volunteer',
          skills: d.skills || ['teamwork'],
          location: d.location || 'India',
          tokens: d.tokens || 0,
          username: d.username,
          operatingZone: d.operatingZone || '',
          preferredNgo: d.preferredNgo || null
        };
        localStorage.setItem('aeroviaUser', JSON.stringify(mapped));

        // render dashboard (ensuring we override any local-only rendering)
        setTimeout(()=> { try { renderDashboardFromLocal(); } catch(e){ console.warn(e); } }, 200);
      } catch (err) {
        console.error('auth handler error', err);
        showNotification('Sign-in succeeded but profile check failed', 'error');
      }
    });
  </script>
</body>
</html>
